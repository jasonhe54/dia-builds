name: Archive Release Build

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Public URL to the ZIP file to archive"
        required: true
        type: string
      app_name:
        description: "The name of the app (e.g., Dia) for the asset filename"
        required: true
        type: string
        default: "Dia"
      version_tag:
        description: "Base version tag (e.g. v1.2.3)"
        required: true
        type: string
      build_number:
        description: "Optional build number (e.g. 1A234)"
        required: false
        type: string
      is_eb_build:
        description: "Early Bird (EB) Build? (Appends -EB to tag)"
        required: false
        type: boolean
        default: true
      release_notes:
        description: "Optional: Paste the HTML-escaped content from Sparkle's <description> tag"
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ inputs.version_tag }}-${{ inputs.build_number }}
  cancel-in-progress: true

jobs:
  archive-release:
    name: Download and Archive Build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-tags: true

      - name: Prepare Version Tag and Asset Name
        id: prep
        run: |
          set -euo pipefail
          BASE_VERSION="${{ inputs.version_tag }}"
          BUILD_NUM="${{ inputs.build_number }}"
          IS_EB="${{ inputs.is_eb_build }}"
          
          FINAL_VERSION_TAG="${BASE_VERSION}"
          if [[ -n "${BUILD_NUM}" ]]; then
            FINAL_VERSION_TAG="${FINAL_VERSION_TAG}-${BUILD_NUM}"
          fi
          if [[ "${IS_EB}" == "true" ]]; then
            FINAL_VERSION_TAG="${FINAL_VERSION_TAG}-EB"
          fi
          
          ASSET_NAME="${{ inputs.app_name }}-${FINAL_VERSION_TAG}.zip"
          ZIP_FILENAME=$(basename "${{ inputs.zip_url }}")

          echo "final_version_tag=${FINAL_VERSION_TAG}" >> "$GITHUB_OUTPUT"
          echo "asset_name=${ASSET_NAME}" >> "$GITHUB_OUTPUT"
          echo "zip_filename=${ZIP_FILENAME}" >> "$GITHUB_OUTPUT"

      - name: Install Pandoc
        if: inputs.release_notes != ''
        run: |
          echo "Installing pandoc..."
          sudo apt-get update
          sudo apt-get install -y pandoc
          
      - name: Format Release Notes
        id: format_notes
        if: inputs.release_notes != ''
        run: |
          set -euo pipefail
          echo "Formatting release notes..."
          RAW_NOTES='${{ inputs.release_notes }}'
          
          UNESCAPED_NOTES=$(echo "${RAW_NOTES}" | \
            sed 's/&lt;/</g' | \
            sed 's/&gt;/>/g' | \
            sed 's/&#39;/'"'"'/g' | \
            sed 's/&quot;/"/g' | \
            sed 's/&amp;/&/g')
          
          # Use 'gfm' (GitHub Flavored Markdown) to prevent '```{=html}' artifacts
          MARKDOWN_NOTES=$(echo "${UNESCAPED_NOTES}" | pandoc -f html -t gfm)
          
          echo "formatted_notes<<EOF" >> "$GITHUB_OUTPUT"
          echo "$MARKDOWN_NOTES" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Download Asset
        id: download
        run: |
          set -euo pipefail
          mkdir -p ./work
          # Save as a generic 'asset.zip'
          DOWNLOAD_PATH="./work/asset.zip"
          
          echo "Downloading asset"
          echo "Saving to: ${DOWNLOAD_PATH}"
          curl -L --fail --show-error -o "${DOWNLOAD_PATH}" "${{ inputs.zip_url }}"
          
          # Output the generic path
          echo "download_path=${DOWNLOAD_PATH}" >> "$GITHUB_OUTPUT"

      - name: Create Draft Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION_TAG: ${{ steps.prep.outputs.final_version_tag }}
          ASSET_NAME: ${{ steps.prep.outputs.asset_name }}
          DOWNLOAD_PATH: ${{ steps.download.outputs.download_path }}
          ZIP_URL: ${{ inputs.zip_url }}
          FORMATTED_NOTES: ${{ steps.format_notes.outputs.formatted_notes }}
        run: |
          set -euo pipefail
          
          if git rev-parse "${VERSION_TAG}" >/dev/null 2>&1; then
            echo "âœ… Git tag ${VERSION_TAG} already exists. Skipping duplicate archival."
          else
            echo "Creating new Git tag and draft release for: ${VERSION_TAG}"
            
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            
            echo "Creating and pushing Git tag: ${VERSION_TAG}"
            git tag "${VERSION_TAG}" -m "Archive release ${VERSION_TAG}"
            git push origin "${VERSION_TAG}"
            
            printf -v BASE_NOTES "Archived from: \`%s\`" "${ZIP_URL}"
            if [[ -n "${FORMATTED_NOTES}" ]]; then
              printf -v FINAL_NOTES "%s\n\n---\n\n%s" "${BASE_NOTES}" "${FORMATTED_NOTES}"
            else
              FINAL_NOTES="${BASE_NOTES}"
            fi
            
            gh release create "${VERSION_TAG}" \
               --title "App Version ${VERSION_TAG}" \
               --notes "${FINAL_NOTES}" \
               --draft \
               "${DOWNLOAD_PATH}#${ASSET_NAME}"
            
            echo "New draft release created."
          fi

      - name: Write to Job Summary
        id: summary
        env:
          VERSION_TAG: ${{ steps.prep.outputs.final_version_tag }}
          ASSET_NAME: ${{ steps.prep.outputs.asset_name }}
          REPO_URL: "[https://github.com/$](https://github.com/$){{ github.repository }}"
          ZIP_FILENAME: ${{ steps.prep.outputs.zip_filename }}
        run: |
          set -euo pipefail
          echo "## ðŸš€ Archive Run Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run Inputs" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Source Filename** | \`${{ env.ZIP_FILENAME }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **App Name** | \`${{ inputs.app_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Base Version** | \`${{ inputs.version_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Number** | \`${{ inputs.build_number }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **EB Build** | \`${{ inputs.is_eb_build }}\` |" >> $GITHUB_STEP_SUMMARY
          if [[ -n "${{ inputs.release_notes }}" ]]; then
            echo "| **Release Notes** | \`(provided & formatted)\` |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Generated Assets" >> $GITHUB_STEP_SUMMARY
          echo "| Asset | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          echo "| **Final Version Tag** | \`${VERSION_TAG}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Uploaded Asset Name** | \`${ASSET_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Draft Release" >> $GITHUB_STEP_SUMMARY
          echo "The asset has been uploaded to a new **draft release**." >> $GITHUB_STEP_SUMMARY
          echo "The source URL and formatted release notes have been saved to the release notes (visible only to repo members)." >> $GITHUB_STEP_SUMMARY

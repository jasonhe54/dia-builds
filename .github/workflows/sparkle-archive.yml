name: Archive Releases from Sparkle Feed

on:
  workflow_dispatch:
    inputs:
      feed_type:
        description: "Which feed to parse for new builds?"
        required: true
        type: choice
        options:
        - Early Bird
        - Release
      app_name:
        description: "The name of the app (e.g., Dia) for the asset filename"
        required: true
        type: string
        default: "Dia"

concurrency:
  group: ${{ github.workflow }}-${{ inputs.feed_type }}
  cancel-in-progress: true

jobs:
  parse-feed:
    name: Parse Sparkle Feed
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.parse.outputs.matrix }}
      is_eb_build: ${{ steps.prep_env.outputs.is_eb_build }}
      feed_url: ${{ steps.prep_env.outputs.feed_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare Environment
        id: prep_env
        env:
          EB_URL: ${{ secrets.SPARKLE_FEED_URL_EB }}
          RELEASE_URL: ${{ secrets.SPARKLE_FEED_URL_RELEASE }}
        run: |
          set -euo pipefail
          if [[ "${{ inputs.feed_type }}" == "Early Bird" ]]; then
            echo "Setting environment for Early Bird feed..."
            echo "is_eb_build=true" >> "$GITHUB_OUTPUT"
            echo "feed_url=${EB_URL}" >> "$GITHUB_OUTPUT"
          else
            echo "Setting environment for Release feed..."
            echo "is_eb_build=false" >> "$GITHUB_OUTPUT"
            echo "feed_url=${RELEASE_URL}" >> "$GITHUB_OUTPUT"
          fi

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          
      - name: Install Python XML requirement
        run: |
          pip install lxml 

      - name: Fetch, Clean, and Parse Feed
        id: parse
        env:
          FEED_URL: ${{ steps.prep_env.outputs.feed_url }}
        run: |
          set -euo pipefail
          echo "Fetching feed..."
          
          # Fetch the feed and clean up the malformed xmlns attributes
          curl -L --fail --show-error "${FEED_URL}" | \
            sed 's/xmlns:_xmlns="xmlns" //' | \
            sed 's/_xmlns:/xmlns:/g' > feed.xml
          
          echo "Contents of cleaned feed (first 50 lines):"
          head -n 50 feed.xml
          
          echo "Parsing cleaned feed with Python script..."
          
          # Make the script executable
          chmod +x ./scripts/parse_feed.py
          
          # Run the python script and capture its stdout
          JSON_MATRIX=$(python3 ./scripts/parse_feed.py feed.xml)
          
          if [[ -z "${JSON_MATRIX}" || "${JSON_MATRIX}" == "[]" ]]; then
            echo "::error::No <item> elements found in the XML feed. Python script failed to parse."
            echo "Feed content:"
            cat feed.xml
            exit 1
          fi
          
          echo "Found items: ${JSON_MATRIX}"
          echo "matrix=${JSON_MATRIX}" >> "$GITHUB_OUTPUT"

  archive-release:
    name: Archive Release
    needs: parse-feed
    if: needs.parse-feed.outputs.matrix != '[]'
    strategy:
      fail-fast: false
      matrix:
        item: ${{ fromJson(needs.parse-feed.outputs.matrix) }}
    uses: ./.github/workflows/create-release.yml
    permissions:
      contents: write
    with:
      build_num: ${{ matrix.item.build_num }}
      short_version_str: ${{ matrix.item.short_version_str }}
      description: ${{ matrix.item.description }}
      zip_url: ${{ matrix.item.zip_url }}
      is_eb_build: ${{ needs.parse-feed.outputs.is_eb_build == 'true' }}
      app_name: ${{ inputs.app_name }}
      feed_url: ${{ needs.parse-feed.outputs.feed_url }}

  job-summary:
    name: Write Summary
    runs-on: ubuntu-latest
    needs: archive-release
    if: always()

    steps:
      - name: Download All Job Results
        uses: actions/download-artifact@v4
        with:
          path: ./all-results
          pattern: job-result-*
          
      - name: Install JQ
        run: sudo apt-get install -y jq
        
      - name: Write Job Summary
        run: |
          set -euo pipefail
          echo "## ðŸ“¦ Batch Archive Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Version Tag | Asset Name | Source Filename | Status |" >> $GITHUB_STEP_SUMMARY
          echo "| :--- | :--- | :--- | :--- |" >> $GITHUB_STEP_SUMMARY
          
          # Check if any results exist
          if [ ! -d "./all-results" ] || [ -z "$(ls -A ./all-results)" ]; then
            echo "| *No archive jobs were run or data was unavailable.* | | | |" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi
          
          # Iterate through all downloaded artifact directories
          for result_dir in ./all-results/job-result-*; do
            if [ -f "$result_dir/result.json" ]; then
              echo "Processing: $result_dir/result.json"
              jq -r '"| `" + .final_version_tag + "` | `" + .asset_name + "` | `" + .zip_filename + "` | " + .status + " |"' "$result_dir/result.json" >> $GITHUB_STEP_SUMMARY
            fi
          done
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Total releases processed:** $(find ./all-results -name 'result.json' | wc -l)" >> $GITHUB_STEP_SUMMARY